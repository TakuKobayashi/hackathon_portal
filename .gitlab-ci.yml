stages:
  - crawl-and-publish

.base_job_template: &base_job_definition
  image: amd2/rails-gitlab-runner
  tags:
    - docker
  cache:
    untracked: true
    key: "$CI_BUILD_NAME"
    paths:
      - vendor

.database_job_template: &database_job_template
  <<: *base_job_definition
  services:
    - mysql:5.7
  variables:
    MYSQL_ALLOW_EMPTY_PASSWORD: "true"
    RAILS_MAX_THREADS: "5"
    RAILS_ENV: production
  before_script:
    - ruby -v
    - bundle install --jobs $(nproc) --path vendor/bundle

CrawlAndPublish:
  <<: *database_job_template
  stage: crawl-and-publish
  allow_failure: true
  script:
    - rails db:setup
    - rails runner Event.import_events!
    - rails backup:export_active_records_data
  artifacts:
    paths:
      - log/